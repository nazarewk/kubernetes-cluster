- file:
    path: "{{ item }}"
    state: directory
    recurse: yes
  with_items:
  - /etc/flannel
  - /etc/systemd/system/flanneld.service.d/
  - /etc/systemd/system/docker.service.d/
  - /etc/kubernetes/cni
  - /etc/kubernetes/cni/net.d

- copy:
    dest: /etc/flannel/options.env
    content: |
      FLANNELD_IFACE={{ ansible_default_ipv4.address }}
      FLANNELD_ETCD_ENDPOINTS={{ ETCD_ENDPOINTS }}

- copy:
    dest: /etc/systemd/system/flanneld.service.d/40-ExecStartPre-symlink.conf
    content: |
      [Service]
      ExecStartPre=/usr/bin/ln -sf /etc/flannel/options.env /run/flannel/options.env

- copy:
    dest: /etc/systemd/system/docker.service.d/40-flannel.conf
    content: |
      [Unit]
      Requires=flanneld.service
      After=flanneld.service
      [Service]
      EnvironmentFile=/etc/kubernetes/cni/docker_opts_cni.env

- copy:
    dest: /etc/kubernetes/cni/docker_opts_cni.env
    content: |
      DOCKER_OPT_BIP=""
      DOCKER_OPT_IPMASQ=""

- copy:
    dest: /etc/kubernetes/cni/net.d/10-flannel.conf
    content: |
      {
          "name": "podnet",
          "type": "flannel",
          "delegate": {
              "isDefaultGateway": true
          }
      }