- file:
    path: "{{ item }}"
    state: directory
    recurse: yes
  with_items:
  - /etc/flannel
  - /etc/systemd/system/flanneld.service.d/
  - /etc/systemd/system/docker.service.d/
  - /etc/kubernetes/cni
  - /etc/kubernetes/cni/net.d

- template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  notify:
  - restart flannel
  with_items:
  - src: flannel/options.env.j2
    dest: /etc/flannel/options.env

  - src: flannel/40-ExecStartPre-symlink.conf.j2
    dest: /etc/systemd/system/flanneld.service.d/40-ExecStartPre-symlink.conf

  - src: flannel/40-flannel.conf.j2
    dest: /etc/systemd/system/docker.service.d/40-flannel.conf

  - src: flannel/docker_opts_cni.env.j2
    dest: /etc/kubernetes/cni/docker_opts_cni.env

  - src: flannel/10-flannel.conf.j2
    dest: /etc/kubernetes/cni/net.d/10-flannel.conf
